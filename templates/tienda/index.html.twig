{# ===================================================================== #}
{#  Cat√°logo de la tienda - Accesibilidad WCAG 2.1 AA                   #}
{# ===================================================================== #}
{% extends 'base.html.twig' %}

{% block title %}Tienda - Economik0{% endblock %}

{% block body %}
<section class="container py-5" aria-labelledby="tienda-heading">
    {# ========== ENCABEZADO ========== #}
    <header class="text-center mb-5">
        <h1 id="tienda-heading" class="display-4 fw-bold">
            Nuestra <span class="text-accent">Tienda</span>
        </h1>
        <p class="lead text-muted">Productos frescos directamente del productor</p>
    </header>

    {# ========== MENSAJES FLASH ACCESIBLES ========== #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label }} alert-dismissible fade show" 
                 role="alert" 
                 aria-live="polite">
                <span>{{ message }}</span>
                <button type="button" 
                        class="btn-close" 
                        data-bs-dismiss="alert" 
                        aria-label="Cerrar mensaje de alerta"></button>
            </div>
        {% endfor %}
    {% endfor %}

    {# ========== BUSCADOR ACCESIBLE ========== #}
    <section aria-labelledby="busqueda-heading" class="mb-5">
        <h2 id="busqueda-heading" class="visually-hidden">B√∫squeda de productos</h2>
        <form method="get" 
              action="{{ path('app_tienda') }}" 
              class="row g-3 align-items-end justify-content-center"
              role="search"
              aria-label="Buscar productos en la tienda">
            
            {# Campo de b√∫squeda #}
            <div class="col-md-5">
                <label for="search-query" class="form-label fw-semibold">
                    Buscar producto
                </label>
                <input type="search" 
                       id="search-query"
                       name="q" 
                       class="form-control form-control-lg" 
                       placeholder="Ej: manzanas, leche..." 
                       value="{{ q|default('') }}"
                       aria-describedby="search-help"
                       autocomplete="off">
                <small id="search-help" class="form-text text-muted visually-hidden">
                    Escribe el nombre del producto que deseas buscar
                </small>
            </div>
            
            {# Filtro por categor√≠a #}
            <div class="col-md-3">
                <label for="search-categoria" class="form-label fw-semibold">
                    Categor√≠a
                </label>
                <select id="search-categoria" 
                        name="categoria" 
                        class="form-select form-select-lg"
                        aria-describedby="categoria-help">
                    <option value="">Todas las categor√≠as</option>
                    {% for cat in categorias|default([]) %}
                        <option value="{{ cat }}" {% if cat == categoria|default('') %}selected{% endif %}>
                            {{ cat }}
                        </option>
                    {% endfor %}
                </select>
                <small id="categoria-help" class="form-text text-muted visually-hidden">
                    Filtra productos por categor√≠a
                </small>
            </div>
            
            {# Bot√≥n de b√∫squeda #}
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary btn-lg w-100">
                    <span aria-hidden="true">üîç</span>
                    <span>Buscar</span>
                </button>
            </div>
        </form>
    </section>

    {# ========== LISTADO DE PRODUCTOS ========== #}
    <section aria-labelledby="productos-heading">
        <h2 id="productos-heading" class="visually-hidden">
            Lista de productos disponibles
        </h2>
        
        {% if productos|length > 0 %}
            <div class="row g-4" role="list" aria-label="Productos disponibles">
                {% for producto in productos %}
                    <article class="col-sm-6 col-lg-4 col-xl-3" role="listitem">
                        <div class="card h-100 shadow-sm product-card">
                            {# Imagen del producto #}
                            {% if producto.imagen %}
                                <img src="{{ asset('uploads/productos/' ~ producto.imagen) }}" 
                                     class="card-img-top product-img" 
                                     alt="Imagen de {{ producto.nombre }}"
                                     loading="lazy"
                                     width="300"
                                     height="200">
                            {% else %}
                                <div class="card-img-top product-img-placeholder d-flex align-items-center justify-content-center bg-light" 
                                     role="img" 
                                     aria-label="Sin imagen disponible para {{ producto.nombre }}">
                                    <span aria-hidden="true" class="display-4 text-muted">üì¶</span>
                                </div>
                            {% endif %}
                            
                            {# Informaci√≥n del producto #}
                            <div class="card-body d-flex flex-column">
                                <h3 class="card-title h5">{{ producto.nombre }}</h3>
                                <p class="text-muted small mb-2">
                                    <span class="visually-hidden">Categor√≠a:</span>
                                    {{ producto.categoria }}
                                </p>
                                <p class="card-text flex-grow-1">
                                    {{ producto.descripcion|slice(0, 80) }}{% if producto.descripcion|length > 80 %}...{% endif %}
                                </p>
                                <p class="fw-bold fs-5 text-primary mb-3">
                                    <span class="visually-hidden">Precio:</span>
                                    {{ producto.precio|number_format(2, ',', '.') }} ‚Ç¨
                                </p>
                                <a href="{{ path('app_tienda_detalle', {id: producto.id}) }}" 
                                   class="btn btn-outline-primary mt-auto"
                                   aria-label="Ver detalles de {{ producto.nombre }}">
                                    Ver Detalle
                                </a>
                            </div>
                        </div>
                    </article>
                {% endfor %}
            </div>
        {% else %}
            {# Estado vac√≠o #}
            <div class="text-center py-5" role="status" aria-live="polite">
                <span aria-hidden="true" class="display-1">üîç</span>
                <h3 class="mt-3">No se encontraron productos</h3>
                <p class="text-muted">
                    Prueba con otros t√©rminos de b√∫squeda o selecciona otra categor√≠a.
                </p>
                <a href="{{ path('app_tienda') }}" class="btn btn-primary">
                    Ver todos los productos
                </a>
            </div>
        {% endif %}
    </section>
</section>
{% endblock %}
