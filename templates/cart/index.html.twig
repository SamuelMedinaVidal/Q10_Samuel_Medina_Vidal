{# ===================================================================== #}
{#  Carrito de compras - Accesibilidad WCAG 2.1 AA                      #}
{# ===================================================================== #}
{% extends 'base.html.twig' %}

{% block title %}Carrito - Economik0{% endblock %}

{% block body %}
<section class="container py-5" aria-labelledby="cart-heading">
    {# ========== ENCABEZADO ========== #}
    <header class="text-center mb-5">
        <h1 id="cart-heading" class="display-4 fw-bold">
            Tu <span class="text-accent">Carrito</span>
        </h1>
    </header>

    {# ========== MENSAJES FLASH ACCESIBLES ========== #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label }} alert-dismissible fade show" 
                 role="alert" 
                 aria-live="polite">
                <span>{{ message }}</span>
                <button type="button" 
                        class="btn-close" 
                        data-bs-dismiss="alert" 
                        aria-label="Cerrar mensaje de alerta"></button>
            </div>
        {% endfor %}
    {% endfor %}

    {% if items|length > 0 %}
        {# ========== TABLA DE PRODUCTOS (ACCESIBLE) ========== #}
        <section aria-labelledby="productos-carrito-heading">
            <h2 id="productos-carrito-heading" class="visually-hidden">
                Productos en tu carrito
            </h2>
            
            <div class="table-responsive">
                <table class="table table-hover align-middle" 
                       aria-describedby="cart-summary">
                    <caption class="visually-hidden">
                        Lista de productos en tu carrito de compras
                    </caption>
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Producto</th>
                            <th scope="col" class="text-center">Precio Unitario</th>
                            <th scope="col" class="text-center">Cantidad</th>
                            <th scope="col" class="text-center">Subtotal</th>
                            <th scope="col" class="text-center">
                                <span class="visually-hidden">Acciones</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                            <tr>
                                {# Producto #}
                                <td>
                                    <div class="d-flex align-items-center gap-3">
                                        {% if item.product.imagen %}
                                            <img src="{{ asset('uploads/productos/' ~ item.product.imagen) }}" 
                                                 alt="Imagen de {{ item.product.nombre }}"
                                                 class="rounded"
                                                 width="60"
                                                 height="60"
                                                 loading="lazy">
                                        {% else %}
                                            <span aria-hidden="true" class="fs-3">üì¶</span>
                                            <span class="visually-hidden">Sin imagen</span>
                                        {% endif %}
                                        <div>
                                            <strong>{{ item.product.nombre }}</strong>
                                            <br>
                                            <small class="text-muted">
                                                <span class="visually-hidden">Categor√≠a:</span>
                                                {{ item.product.categoria }}
                                            </small>
                                        </div>
                                    </div>
                                </td>

                                {# Precio unitario #}
                                <td class="text-center">
                                    <span class="visually-hidden">Precio:</span>
                                    {{ item.product.precio|number_format(2, ',', '.') }} ‚Ç¨
                                </td>

                                {# Cantidad con controles accesibles #}
                                <td class="text-center">
                                    <div class="d-flex justify-content-center align-items-center gap-2" 
                                         role="group" 
                                         aria-label="Control de cantidad para {{ item.product.nombre }}">
                                        
                                        {# Bot√≥n decrementar #}
                                        <a href="{{ path('app_cart_decrease', {id: item.product.id}) }}" 
                                           class="btn btn-outline-secondary btn-sm {% if item.quantity <= 1 %}disabled{% endif %}"
                                           aria-label="Reducir cantidad de {{ item.product.nombre }}"
                                           {% if item.quantity <= 1 %}aria-disabled="true" tabindex="-1"{% endif %}>
                                            <span aria-hidden="true">‚àí</span>
                                        </a>

                                        {# Cantidad actual #}
                                        <span class="fw-bold px-2" 
                                              aria-live="polite" 
                                              aria-atomic="true">
                                            <span class="visually-hidden">Cantidad actual:</span>
                                            {{ item.quantity }}
                                        </span>

                                        {# Bot√≥n incrementar #}
                                        <a href="{{ path('app_cart_increase', {id: item.product.id}) }}" 
                                           class="btn btn-outline-secondary btn-sm {% if item.quantity >= item.product.cantidad %}disabled{% endif %}"
                                           aria-label="Aumentar cantidad de {{ item.product.nombre }}"
                                           {% if item.quantity >= item.product.cantidad %}aria-disabled="true" tabindex="-1"{% endif %}>
                                            <span aria-hidden="true">+</span>
                                        </a>
                                    </div>
                                </td>

                                {# Subtotal #}
                                <td class="text-center fw-bold">
                                    <span class="visually-hidden">Subtotal:</span>
                                    {{ (item.product.precio * item.quantity)|number_format(2, ',', '.') }} ‚Ç¨
                                </td>

                                {# Eliminar #}
                                <td class="text-center">
                                    <form action="{{ path('app_cart_remove', {id: item.product.id}) }}" 
                                          method="post"
                                          aria-label="Eliminar {{ item.product.nombre }} del carrito">
                                        <button type="submit" 
                                                class="btn btn-outline-danger btn-sm"
                                                aria-label="Eliminar {{ item.product.nombre }}">
                                            <span aria-hidden="true">üóëÔ∏è</span>
                                            <span class="visually-hidden">Eliminar</span>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <td colspan="3" class="text-end fw-bold fs-5">
                                Total:
                            </td>
                            <td class="text-center fw-bold fs-5 text-primary" id="cart-summary">
                                {{ total|number_format(2, ',', '.') }} ‚Ç¨
                            </td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </section>

        {# ========== ACCIONES DEL CARRITO ========== #}
        <nav aria-label="Acciones del carrito" class="d-flex justify-content-between flex-wrap gap-3 mt-4">
            <a href="{{ path('app_tienda') }}" class="btn btn-outline-secondary">
                <span aria-hidden="true">‚Üê</span>
                Seguir Comprando
            </a>
            <div class="d-flex gap-2">
                <form action="{{ path('app_cart_clear') }}" method="post">
                    <button type="submit" 
                            class="btn btn-outline-danger"
                            aria-label="Vaciar todo el carrito">
                        <span aria-hidden="true">üóëÔ∏è</span>
                        Vaciar Carrito
                    </button>
                </form>
                <a href="#" class="btn btn-primary" aria-disabled="true">
                    <span aria-hidden="true">üí≥</span>
                    Finalizar Compra
                </a>
            </div>
        </nav>

    {% else %}
        {# ========== CARRITO VAC√çO ========== #}
        <div class="text-center py-5" role="status" aria-live="polite">
            <span aria-hidden="true" class="display-1">üõí</span>
            <h2 class="mt-3">Tu carrito est√° vac√≠o</h2>
            <p class="text-muted mb-4">
                Explora nuestra tienda y descubre productos frescos de productores locales.
            </p>
            <a href="{{ path('app_tienda') }}" class="btn btn-primary btn-lg">
                <span aria-hidden="true">üõçÔ∏è</span>
                Ir a la Tienda
            </a>
        </div>
    {% endif %}
</section>
{% endblock %}
